name: PR Validation

# Ëß¶ÂèëÊù°‰ª∂ÔºöPR ÊâìÂºÄ„ÄÅÁºñËæë„ÄÅÂêåÊ≠•„ÄÅÈáçÊñ∞ÊâìÂºÄÊó∂
on:
  pull_request:
    types: [opened, edited, synchronize, reopened]

# ÈÅøÂÖçÈáçÂ§çËøêË°åÔºöÂêå‰∏ÄPRÁöÑÊñ∞Êèê‰∫§‰ºöÂèñÊ∂à‰πãÂâçÁöÑËøêË°å
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

# ÈôêÂà∂Â∑•‰ΩúÊµÅÊùÉÈôêÔºàÂÆâÂÖ®ÊúÄ‰Ω≥ÂÆûË∑µÔºâ
permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  # Job 1: PR Title Check
  pr-title-check:
    name: PR Title Check
    runs-on: ubuntu-latest
    
    steps:
      - name: Check PR Title Format
        uses: amannn/action-semantic-pull-request@v5
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          # Allowed types
          types: |
            feat
            fix
            docs
            style
            refactor
            perf
            test
            build
            ci
            chore
            revert
          # Scope is optional
          requireScope: false
          # Subject must start with lowercase letter or non-ASCII characters (e.g., Chinese)
          subjectPattern: ^(?![A-Z]).+$
          subjectPatternError: |
            ‚ùå PR title format is incorrect!
            
            **Wrong examples:**
            - `feat: Add new feature` (first letter should be lowercase)
            - `add new feature` (missing type prefix)
            - `featadd new feature` (missing colon and space)
            
            **Correct format:**
            - `type: brief description`
            - `type(scope): brief description`
            
            **Description rules:**
            - Start with lowercase letter: `feat: add product feature`
            - Or use Chinese: `feat: Ê∑ªÂä†‰∫ßÂìÅÁâπÊÄßÈÖçÁΩÆ`
            - Do NOT start with uppercase letter: ~~`feat: Add feature`~~
            
            **Allowed types:**
            - `feat`: new feature / Êñ∞ÂäüËÉΩ
            - `fix`: bug fix / Bug ‰øÆÂ§ç
            - `docs`: documentation / ÊñáÊ°£Êõ¥Êñ∞
            - `style`: code formatting / ‰ª£Á†ÅÊ†ºÂºè
            - `refactor`: code refactoring / ‰ª£Á†ÅÈáçÊûÑ
            - `perf`: performance / ÊÄßËÉΩ‰ºòÂåñ
            - `test`: testing / ÊµãËØï
            - `build`: build system / ÊûÑÂª∫Á≥ªÁªü
            - `ci`: CI/CD changes / CI/CD ÂèòÊõ¥
            - `chore`: other changes / ÂÖ∂‰ªñÂèòÊõ¥
            - `revert`: revert commit / ÂõûÊªöÊèê‰∫§
            
            **Correct examples:**
            ‚úÖ `feat: add product feature configuration`
            ‚úÖ `fix: fix product list pagination issue`
            ‚úÖ `feat(product): add feature configuration panel`
            ‚úÖ `docs: update README deployment guide`
            ‚úÖ `feat: Ê∑ªÂä†‰∫ßÂìÅÁâπÊÄßÈÖçÁΩÆ` (Chinese is OK)
            ‚úÖ `fix: ‰øÆÂ§ç‰∫ßÂìÅÂàóË°®ÂàÜÈ°µÈóÆÈ¢ò` (Chinese is OK)

  # Job 2: PR Content Check
  pr-content-check:
    name: PR Content Check
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check PR Description and Required Fields
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const body = pr.body || '';
            
            console.log('=== PR Body ===');
            console.log(body);
            console.log('===============');
            
            // Required checks
            const checks = {
              hasDescription: {
                test: () => {
                  // Find Description section
                  const descSection = body.match(/##\s*üìù?\s*Description\s*([\s\S]*?)(?=##|$)/i);
                  if (!descSection) return false;
                  
                  // Remove HTML comments and whitespace
                  const content = descSection[1]
                    .replace(/<!--[\s\S]*?-->/g, '')
                    .replace(/\s+/g, ' ')
                    .trim();
                  
                  return content.length >= 10;
                },
                message: '‚ùå Missing description or description too short (at least 10 characters required)',
                suggestion: 'Please provide a detailed description of your changes in the "Description" section.'
              },
              hasTypeOfChange: {
                test: () => {
                  // Find Type of Change section and check if at least one is selected
                  const typeSection = body.match(/##\s*‚úÖ?\s*Type of Change\s*([\s\S]*?)(?=##|$)/i);
                  if (!typeSection) return false;
                  
                  return /- \[x\]/i.test(typeSection[1]);
                },
                message: '‚ùå No change type selected',
                suggestion: 'Please select at least one change type in the "Type of Change" section (Bug fix, New feature, etc.).'
              }
            };
            
            // Optional checks (warnings only)
            const optionalChecks = {
              hasRelatedIssues: {
                test: () => {
                  // Look for issue links: Fix #123, Close #456, Resolve #789
                  return /(?:close[sd]?|fix(?:e[sd])?|resolve[sd]?)\s+#\d+/i.test(body);
                },
                message: 'üí° Consider linking related issues (e.g., `Fix #123` or `Close #456`)'
              },
              hasTestingInfo: {
                test: () => {
                  // Check if Testing section is filled
                  const testSection = body.match(/##\s*üß™?\s*Testing\s*([\s\S]*?)(?=##|$)/i);
                  if (!testSection) return false;
                  
                  const content = testSection[1]
                    .replace(/<!--[\s\S]*?-->/g, '')
                    .replace(/\s+/g, ' ')
                    .trim();
                  
                  return content.length > 10;
                },
                message: 'üí° Consider describing how you tested these changes'
              }
            };
            
            // Execute checks
            const errors = [];
            const suggestions = [];
            const warnings = [];
            
            for (const [key, check] of Object.entries(checks)) {
              if (!check.test()) {
                errors.push({ message: check.message, suggestion: check.suggestion });
              }
            }
            
            for (const [key, check] of Object.entries(optionalChecks)) {
              if (!check.test()) {
                warnings.push(check.message);
              }
            }
            
            // Check PR size
            const additions = pr.additions || 0;
            const deletions = pr.deletions || 0;
            const totalChanges = additions + deletions;
            
            let sizeWarning = '';
            if (totalChanges > 1000) {
              sizeWarning = `‚ö†Ô∏è **Large PR** (${totalChanges} lines): Consider splitting into smaller PRs for easier review.`;
            } else if (totalChanges > 500) {
              sizeWarning = `‚ö†Ô∏è **Medium PR** (${totalChanges} lines): Please ensure the PR is focused on a single feature or fix.`;
            }
            
            // Generate report
            let comment = '## üìã PR Content Check Report\n\n';
            
            if (errors.length === 0) {
              comment += '### ‚úÖ All required checks passed\n\n';
            } else {
              comment += '### ‚ùå Required items need attention\n\n';
              errors.forEach(error => {
                comment += `${error.message}\n`;
                if (error.suggestion) {
                  comment += `   üëâ ${error.suggestion}\n`;
                }
                comment += '\n';
              });
            }
            
            if (warnings.length > 0) {
              comment += '### üí° Suggestions (Optional)\n\n';
              warnings.forEach(warning => {
                comment += `${warning}\n`;
              });
              comment += '\n';
            }
            
            if (sizeWarning) {
              comment += '### üìä PR Size Check\n\n';
              comment += `${sizeWarning}\n\n`;
            }
            
            if (errors.length === 0 && warnings.length === 0 && !sizeWarning) {
              comment += '---\n\n';
              comment += 'üéâ **Perfect!** Your PR is well-formatted and complete, ready for review.\n';
            } else {
              comment += '---\n\n';
              comment += '### üìù PR Content Requirements\n\n';
              comment += '**Required:**\n';
              comment += '- **Description**: Clear explanation of your changes (at least 10 characters)\n';
              comment += '- **Type of Change**: Check at least one change type\n\n';
              comment += '**Optional but recommended:**\n';
              comment += '- **Related Issues**: Link issues using `Fix #123`, `Close #456`, etc.\n';
              comment += '- **Testing**: Describe how you tested these changes\n';
              comment += '- **Checklist**: Check other relevant items (code formatting, self-review, tests, etc.)\n\n';
              comment += '**Example format:**\n';
              comment += '```markdown\n';
              comment += '## üìù Description\n\n';
              comment += '- Refactored client initialization method\n';
              comment += '- Optimized parameter handling logic\n\n';
              comment += '## üîó Related Issues\n\n';
              comment += 'Fix #123\n\n';
              comment += '## ‚úÖ Type of Change\n\n';
              comment += '- [x] Bug fix (non-breaking change)\n';
              comment += '- [ ] New feature (non-breaking change)\n\n';
              comment += '## üß™ Testing\n\n';
              comment += '- [x] Manual testing completed\n';
              comment += '- [x] All tests pass locally\n';
              comment += '```\n';
            }
            
            // Output to Job Summary (visible in PR checks)
            await core.summary
              .addRaw(comment)
              .write();
            
            // Output to console
            console.log('\n' + comment);
            
            // Create annotations for errors and warnings
            errors.forEach(error => {
              core.error(error.message.replace(/‚ùå\s*/, ''), {
                title: 'PR Content Check Failed',
                file: '.github/PULL_REQUEST_TEMPLATE.md'
              });
            });
            
            warnings.forEach(warning => {
              core.warning(warning.replace(/üí°\s*/, ''), {
                title: 'PR Content Suggestion',
                file: '.github/PULL_REQUEST_TEMPLATE.md'
              });
            });
            
            // Fail if there are required items incomplete
            if (errors.length > 0) {
              core.setFailed(`PR content check failed: ${errors.length} required item(s) incomplete`);
            }

  # Job 3: PR Size Check
  pr-size-check:
    name: PR Size Check
    runs-on: ubuntu-latest
    
    steps:
      - name: Check PR Change Size
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const additions = pr.additions || 0;
            const deletions = pr.deletions || 0;
            const totalChanges = additions + deletions;
            const changedFiles = pr.changed_files || 0;
            
            console.log(`PR Change Statistics:`);
            console.log(`  Lines added: ${additions}`);
            console.log(`  Lines deleted: ${deletions}`);
            console.log(`  Total lines changed: ${totalChanges}`);
            console.log(`  Files changed: ${changedFiles}`);
            
            let summary = '## üìä PR Size Statistics\n\n';
            summary += `| Metric | Value |\n`;
            summary += `|--------|-------|\n`;
            summary += `| ‚ûï Lines Added | ${additions} |\n`;
            summary += `| ‚ûñ Lines Deleted | ${deletions} |\n`;
            summary += `| üìù Total Changes | ${totalChanges} |\n`;
            summary += `| üìÅ Files Changed | ${changedFiles} |\n\n`;
            
            let sizeLabel = '';
            let sizeEmoji = '';
            let recommendation = '';
            
            if (totalChanges < 100) {
              sizeLabel = 'üü¢ XS (Extra Small)';
              sizeEmoji = 'üü¢';
              recommendation = '‚úÖ **Excellent!** Small PRs are easy to review and merge quickly.';
            } else if (totalChanges < 300) {
              sizeLabel = 'üü¢ S (Small)';
              sizeEmoji = 'üü¢';
              recommendation = '‚úÖ **Great!** Good PR size, easy to review.';
            } else if (totalChanges < 600) {
              sizeLabel = 'üü° M (Medium)';
              sizeEmoji = 'üü°';
              recommendation = '‚ö†Ô∏è **Medium PR**. Please ensure the PR is focused on a single feature or fix.';
            } else if (totalChanges < 1000) {
              sizeLabel = 'üü† L (Large)';
              sizeEmoji = 'üü†';
              recommendation = '‚ö†Ô∏è **Large PR**. Consider splitting into multiple smaller PRs for easier review.';
            } else {
              sizeLabel = 'üî¥ XL (Extra Large)';
              sizeEmoji = 'üî¥';
              recommendation = '‚ùå **Very Large PR!** Strongly recommend splitting into multiple smaller PRs:\n' +
                              '   - Each PR focused on a single feature or fix\n' +
                              '   - Easier code review and issue tracking\n' +
                              '   - Reduces risk of introducing bugs';
            }
            
            summary += `### ${sizeEmoji} PR Size Assessment: ${sizeLabel}\n\n`;
            summary += `${recommendation}\n\n`;
            
            if (changedFiles > 20) {
              summary += `‚ö†Ô∏è **Note**: ${changedFiles} files changed. Please ensure:\n`;
              summary += `- All changes are related to this PR's goal\n`;
              summary += `- No unrelated files are accidentally included\n\n`;
            }
            
            summary += '---\n\n';
            summary += '### üí° PR Size Best Practices\n\n';
            summary += '- **Ideal size**: < 300 lines changed\n';
            summary += '- **Acceptable size**: 300-600 lines\n';
            summary += '- **Should split**: > 1000 lines\n';
            summary += '- **Single responsibility**: Each PR should do one thing\n';
            summary += '- **Iterative approach**: Implement large features through multiple small PRs\n';
            
            await core.summary
              .addRaw(summary)
              .write();
            
            console.log('\n' + summary);
            
            // Warning for very large PRs (won't fail, just a reminder)
            if (totalChanges > 1000) {
              core.warning(`PR is very large (${totalChanges} lines), consider splitting into smaller PRs`, {
                title: 'PR Size Warning',
                file: '.github/PULL_REQUEST_TEMPLATE.md'
              });
            }

  # Summary of all validation results
  pr-validation-summary:
    name: PR Validation Summary
    runs-on: ubuntu-latest
    needs: [pr-title-check, pr-content-check, pr-size-check]
    if: always()
    
    steps:
      - name: Check All Validation Status
        uses: actions/github-script@v7
        with:
          script: |
            const jobs = [
              { name: 'PR Title Check', status: '${{ needs.pr-title-check.result }}' },
              { name: 'PR Content Check', status: '${{ needs.pr-content-check.result }}' },
              { name: 'PR Size Check', status: '${{ needs.pr-size-check.result }}' }
            ];
            
            let summary = '## ‚úÖ PR Validation Summary\n\n';
            let allPassed = true;
            
            jobs.forEach(job => {
              let icon = '‚úÖ';
              let statusText = job.status;
              
              if (job.status === 'success') {
                icon = '‚úÖ';
                statusText = 'Passed';
              } else if (job.status === 'failure') {
                icon = '‚ùå';
                statusText = 'Failed';
                allPassed = false;
              } else if (job.status === 'cancelled') {
                icon = 'üö´';
                statusText = 'Cancelled';
                allPassed = false;
              } else if (job.status === 'skipped') {
                icon = '‚è≠Ô∏è';
                statusText = 'Skipped';
                allPassed = false;
              } else {
                icon = '‚ö†Ô∏è';
                allPassed = false;
              }
              
              summary += `${icon} **${job.name}**: ${statusText}\n`;
            });
            
            summary += '\n---\n\n';
            
            if (allPassed) {
              summary += 'üéâ **All validations passed!**\n\n';
              summary += 'Your PR meets all format and content requirements and is ready for review.\n';
            } else {
              summary += '‚ö†Ô∏è **Some validations failed**\n\n';
              summary += 'Please review the failed checks above and fix the issues. The checks will automatically re-run after you fix them.\n\n';
              summary += '### üìö Resources\n\n';
              summary += '- [Contributing Guide](CONTRIBUTING.md)\n';
              summary += '- [PR Guide](PR_GUIDE.md)\n';
            }
            
            await core.summary
              .addRaw(summary)
              .write();
            
            console.log(summary);
            
            if (!allPassed) {
              core.setFailed('Some PR validations failed');
            }

